<div class="grid gap-8 lg:grid-cols-12 lg:items-start" x-data="{
      searchQuery: '',
      searchResults: [],
      isSearching: false,
      showResults: false,
      posts: [],
      loading: false,
      hasMore: true,
      offset: 0,
      limit: 10,
      init() {
        this.loadPosts();
        const observer = new IntersectionObserver((entries) => {
          if (entries[0].isIntersecting && this.hasMore && !this.loading && !this.searchQuery.trim()) {
            this.loadPosts();
          }
        }, { threshold: 0.1 });
        const sentinel = document.getElementById('load-more-sentinel');
        if (sentinel) observer.observe(sentinel);
      },
      async loadPosts() {
        if (this.loading) return;
        this.loading = true;
        try {
          const response = await fetch(`/api/blog/posts?offset=${this.offset}&limit=${this.limit}`);
          const data = await response.json();
          if (data.posts && data.posts.length > 0) {
            this.posts = [...this.posts, ...data.posts];
            this.offset += data.posts.length;
            this.hasMore = data.posts.length === this.limit;
          } else {
            this.hasMore = false;
          }
        } catch (error) {
          console.error('Error loading posts:', error);
          this.hasMore = false;
        } finally {
          this.loading = false;
        }
      },
      get displayedPosts() {
        return this.searchQuery.trim() ? this.searchResults : this.posts;
      },
      get isShowingSearchResults() {
        return this.searchQuery.trim().length > 0;
      }
    }">
  <div class="lg:col-span-8">
    <h1 class="text-3xl font-extrabold tracking-tight sm:text-4xl">Blog</h1>
    <p class="mt-3 text-base leading-relaxed text-slate-700 dark:text-slate-300">
      Security and privacy insights, guides, and updates.
    </p>

    <!-- Search Bar -->
    <div class="relative mt-6">
      <div class="relative">
        <input
          type="text"
          x-model="searchQuery"
          @input.debounce.200ms="
            if (searchQuery.trim()) {
              isSearching = true;
              fetch('/api/blog/search?q=' + encodeURIComponent(searchQuery))
                .then(res => res.json())
                .then(data => {
                  searchResults = data;
                  isSearching = false;
                  showResults = true;
                })
                .catch(() => {
                  isSearching = false;
                  showResults = false;
                });
            } else {
              searchResults = [];
              showResults = false;
            }
          "
          @focus="if (searchResults.length > 0) showResults = true"
          @blur="setTimeout(() => showResults = false, 200)"
          placeholder="Search blog posts..."
          class="w-full rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 placeholder-slate-500 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder-slate-400 dark:focus:border-slate-700 dark:focus:ring-slate-700"
        />
        <svg class="absolute right-3 top-2.5 h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      <!-- Search Results Dropdown -->
      <div x-show="showResults && searchResults.length > 0" x-cloak
        class="absolute z-10 mt-2 w-full max-w-2xl rounded-lg border border-slate-200 bg-white shadow-lg dark:border-slate-800 dark:bg-slate-900">
        <div class="max-h-96 overflow-y-auto">
          <template x-for="post in searchResults" :key="post.slug">
            <a :href="'/blog/' + post.slug"
              class="flex gap-3 border-b border-slate-100 px-4 py-3 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800">
              <template x-if="post.coverImage">
                <img :src="post.coverImage" :alt="post.title" class="w-16 h-16 object-cover rounded flex-shrink-0" />
              </template>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-slate-900 dark:text-slate-100" x-text="post.title"></h3>
                <p class="mt-1 text-sm text-slate-600 dark:text-slate-400" x-text="post.description"></p>
              </div>
            </a>
          </template>
        </div>
      </div>
    </div>

    <!-- Blog Posts List -->
    <div id="blog-posts" class="mt-8 space-y-6">
      <template x-for="post in displayedPosts" :key="post.slug">
        <article class="rounded-xl border border-slate-200 bg-white overflow-hidden dark:border-slate-800 dark:bg-slate-900">
          <a :href="'/blog/' + post.slug" class="block">
            <template x-if="post.coverImage">
              <div class="w-full h-48 overflow-hidden">
                <img :src="post.coverImage" :alt="post.title" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
              </div>
            </template>
          </a>
          <div class="p-6">
            <h2 class="text-xl font-bold">
              <a :href="'/blog/' + post.slug" class="text-slate-900 hover:text-slate-700 dark:text-slate-100 dark:hover:text-slate-300" x-text="post.title"></a>
            </h2>
            <time class="mt-2 block text-sm text-slate-500 dark:text-slate-400" :datetime="post.date" x-text="new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })"></time>
            <p class="mt-2 text-slate-700 dark:text-slate-300" x-text="post.description"></p>
            <div class="mt-4 flex flex-wrap gap-2" x-show="post.tags && post.tags.length > 0">
              <template x-for="tag in post.tags" :key="tag">
                <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-700 dark:bg-slate-800 dark:text-slate-300" x-text="tag"></span>
              </template>
            </div>
          </div>
        </article>
      </template>

      <!-- Loading indicator for search -->
      <div x-show="isSearching && isShowingSearchResults" class="text-center py-8 text-slate-500 dark:text-slate-400">
        Searching...
      </div>

      <!-- Loading indicator for pagination -->
      <div x-show="loading && !isShowingSearchResults" class="text-center py-8 text-slate-500 dark:text-slate-400">
        Loading more posts...
      </div>

      <!-- End of list indicator (only show when not searching) -->
      <div x-show="!hasMore && posts.length > 0 && !isShowingSearchResults" class="text-center py-8 text-slate-500 dark:text-slate-400">
        No more posts to load.
      </div>

      <!-- Empty state for search -->
      <div x-show="!isSearching && isShowingSearchResults && searchResults.length === 0" class="text-center py-12 text-slate-500 dark:text-slate-400">
        <p>No blog posts found matching your search.</p>
      </div>

      <!-- Empty state for normal posts -->
      <div x-show="!loading && !isShowingSearchResults && posts.length === 0" class="text-center py-12 text-slate-500 dark:text-slate-400">
        <p>No blog posts found.</p>
      </div>

      <!-- Sentinel for infinite scroll (only when not searching) -->
      <div x-show="!isShowingSearchResults" id="load-more-sentinel" class="h-1"></div>
    </div>
  </div>

  <aside class="lg:col-span-4">
    <div class="rounded-2xl border border-slate-200 bg-white p-5 dark:border-slate-800 dark:bg-slate-900">
      <h2 class="text-sm font-bold">About the Blog</h2>
      <p class="mt-3 text-sm text-slate-700 dark:text-slate-300">
        Stay updated with the latest security and privacy insights, practical guides, and helpful resources.
      </p>
    </div>
  </aside>
</div>

